# å·¥å…·è°ƒç”¨ç»Ÿè®¡åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

MCP Server ç°åœ¨æ”¯æŒè‡ªåŠ¨ç»Ÿè®¡æ¯ä¸ª task è°ƒç”¨å·¥å…·çš„æˆåŠŸä¸å¤±è´¥æƒ…å†µï¼Œå¹¶ç”Ÿæˆè¯¦ç»†çš„ç»Ÿè®¡æŠ¥å‘Šã€‚

**âš¡ é‡è¦ç‰¹æ€§**: æ•°æ®ä¼šå®æ—¶æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå³ä½¿è¿›ç¨‹å´©æºƒä¹Ÿä¸ä¼šä¸¢å¤±ï¼

## åŠŸèƒ½ç‰¹æ€§

- âœ… è‡ªåŠ¨è®°å½•æ¯æ¬¡å·¥å…·è°ƒç”¨çš„æˆåŠŸ/å¤±è´¥çŠ¶æ€
- â±ï¸ è®°å½•æ¯æ¬¡è°ƒç”¨çš„è€—æ—¶
- ğŸ’¾ **å®æ—¶æŒä¹…åŒ–**: æ•°æ®æŒç»­ä¿å­˜åˆ° JSONL æ–‡ä»¶ï¼Œè¿›ç¨‹å®‰å…¨
- ğŸ“Š ç”Ÿæˆä»»åŠ¡çº§åˆ«å’Œå·¥å…·çº§åˆ«çš„ç»Ÿè®¡æŠ¥å‘Š
- ğŸ“ˆ è®¡ç®—æˆåŠŸç‡å’Œå¤±è´¥æ¬¡æ•°
- ğŸ’¾ è‡ªåŠ¨å¯¼å‡º JSON æ ¼å¼çš„è¯¦ç»†æŠ¥å‘Š
- ğŸ” æ”¯æŒæŸ¥è¯¢ç‰¹å®šä»»åŠ¡æˆ–å·¥å…·çš„ç»Ÿè®¡ä¿¡æ¯
- ğŸ”„ æ”¯æŒä»å†å²æ—¥å¿—æ¢å¤æ•°æ®

## å¯ç”¨ç»Ÿè®¡åŠŸèƒ½

ç»Ÿè®¡åŠŸèƒ½é»˜è®¤å¯ç”¨ã€‚å¯åŠ¨ MCP Server æ—¶ä¼šè‡ªåŠ¨å¼€å§‹æ”¶é›†ç»Ÿè®¡æ•°æ®ï¼š

```bash
python src/mcp_server/main.py --config config.json
```

### å‘½ä»¤è¡Œå‚æ•°

```bash
python src/mcp_server/main.py \
  --config config.json \
  --enable-stats \              # å¯ç”¨ç»Ÿè®¡ï¼ˆé»˜è®¤å¼€å¯ï¼‰
  --stats-dir tool_stats        # ç»Ÿè®¡æ•°æ®è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ï¼štool_statsï¼‰
```

## ç»Ÿè®¡æ•°æ®ç»“æ„

### ä¿å­˜çš„æ–‡ä»¶

1. **å®æ—¶æ—¥å¿—** (`tool_stats/realtime_calls.jsonl`):
   - JSONL æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼‰
   - è¿è¡Œæ—¶æŒç»­è¿½åŠ ï¼Œé»˜è®¤æ¯ 10 æ¬¡è°ƒç”¨ä¿å­˜ä¸€æ¬¡
   - å³ä½¿è¿›ç¨‹å´©æºƒï¼Œå·²ä¿å­˜çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±
   - å¯ç”¨äºæ•°æ®æ¢å¤å’Œäº‹ååˆ†æ

2. **å®Œæ•´æŠ¥å‘Š** (`tool_stats/tool_stats_report_YYYYMMDD_HHMMSS.json`):
   - æœåŠ¡å™¨å…³é—­æ—¶è‡ªåŠ¨ç”Ÿæˆ
   - åŒ…å«æ±‡æ€»ç»Ÿè®¡å’Œè¯¦ç»†è®°å½•
   - ç¾åŒ–çš„ JSON æ ¼å¼ï¼Œæ˜“äºé˜…è¯»

ğŸ“– è¯¦ç»†çš„æ•°æ®æ ¼å¼è¯´æ˜è¯·å‚è€ƒ: [TOOL_STATS_DATA_FORMAT.md](TOOL_STATS_DATA_FORMAT.md)

### ä»»åŠ¡çº§åˆ«ç»Ÿè®¡

æ¯ä¸ªä»»åŠ¡çš„ç»Ÿè®¡åŒ…æ‹¬ï¼š
- `task_id`: ä»»åŠ¡ ID
- `total_calls`: æ€»è°ƒç”¨æ¬¡æ•°
- `success_calls`: æˆåŠŸè°ƒç”¨æ¬¡æ•°
- `failed_calls`: å¤±è´¥è°ƒç”¨æ¬¡æ•°
- `success_rate`: æˆåŠŸç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
- `tool_breakdown`: å„å·¥å…·çš„è°ƒç”¨æ˜ç»†

### å·¥å…·çº§åˆ«ç»Ÿè®¡

æ¯ä¸ªå·¥å…·çš„ç»Ÿè®¡åŒ…æ‹¬ï¼š
- `tool_name`: å·¥å…·åç§°
- `total_calls`: æ€»è°ƒç”¨æ¬¡æ•°
- `success_calls`: æˆåŠŸè°ƒç”¨æ¬¡æ•°
- `failed_calls`: å¤±è´¥è°ƒç”¨æ¬¡æ•°
- `success_rate`: æˆåŠŸç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰

### è°ƒç”¨è®°å½•

æ¯æ¬¡å·¥å…·è°ƒç”¨è®°å½•åŒ…æ‹¬ï¼š
- `tool_name`: å·¥å…·åç§°
- `task_id`: ä»»åŠ¡ ID
- `timestamp`: è°ƒç”¨æ—¶é—´
- `success`: æ˜¯å¦æˆåŠŸ
- `error_message`: é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
- `duration_ms`: æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
- `args`: è°ƒç”¨å‚æ•°ï¼ˆä»…åœ¨å¤±è´¥æ—¶è®°å½•ï¼‰

## æŸ¥çœ‹ç»Ÿè®¡æŠ¥å‘Š

ä½¿ç”¨ `view_tool_stats.py` è„šæœ¬æŸ¥çœ‹ç»Ÿè®¡æ•°æ®ï¼š

### 1. æŸ¥çœ‹ç»Ÿè®¡æ‘˜è¦

```bash
python view_tool_stats.py summary
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
============================================================
ğŸ“Š Tool Call Statistics Summary
============================================================

ğŸ¯ Overall Statistics:
  Total Tasks: 15
  Total Calls: 234
  Success: 218 (93.16%)
  Failed: 16

ğŸ”§ Tool Statistics (Top 10):
  search_documents:
    Calls: 89, Success Rate: 95.51%
  execute_bash:
    Calls: 54, Success Rate: 100.0%
  ...
```

### 2. åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡

```bash
python view_tool_stats.py list-tasks
```

### 3. æŸ¥çœ‹ç‰¹å®šä»»åŠ¡çš„ç»Ÿè®¡

```bash
python view_tool_stats.py task --task-id task_001
```

### 4. æŸ¥çœ‹å·¥å…·ç»Ÿè®¡

```bash
# æŸ¥çœ‹æ‰€æœ‰å·¥å…·ç»Ÿè®¡
python view_tool_stats.py tool

# æŸ¥çœ‹ç‰¹å®šå·¥å…·ç»Ÿè®¡
python view_tool_stats.py tool --tool-name search_documents
```

### 5. æŸ¥çœ‹å¤±è´¥çš„è°ƒç”¨

```bash
# æŸ¥çœ‹æ‰€æœ‰å¤±è´¥çš„è°ƒç”¨
python view_tool_stats.py failures

# æŸ¥çœ‹ç‰¹å®šä»»åŠ¡çš„å¤±è´¥è°ƒç”¨
python view_tool_stats.py failures --task-id task_001
```

### 6. å¯¼å‡ºå®Œæ•´æŠ¥å‘Š

```bash
# è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
python view_tool_stats.py export

# æŒ‡å®šè¾“å‡ºæ–‡ä»¶å
python view_tool_stats.py export --output my_report.json
```

## æŠ¥å‘Šæ–‡ä»¶æ ¼å¼

å¯¼å‡ºçš„ JSON æŠ¥å‘ŠåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š

```json
{
  "generated_at": "2024-01-15T10:30:00.123456",
  "all_tasks_report": {
    "summary": {
      "total_tasks": 15,
      "total_calls": 234,
      "total_success": 218,
      "total_failed": 16,
      "overall_success_rate": 93.16
    },
    "tasks": [...]
  },
  "tool_report": {
    "total_tools": 12,
    "tools": [...]
  },
  "failed_calls": [...],
  "detailed_records": [...]
}
```

## è‡ªåŠ¨æŠ¥å‘Šç”Ÿæˆ

æœåŠ¡å™¨å…³é—­æ—¶ä¼šè‡ªåŠ¨ï¼š
1. ç”Ÿæˆæœ€ç»ˆç»Ÿè®¡æŠ¥å‘Š
2. æ‰“å°ç»Ÿè®¡æ‘˜è¦åˆ°æ§åˆ¶å°
3. ä¿å­˜è¯¦ç»†æŠ¥å‘Šåˆ° JSON æ–‡ä»¶

æ”¯æŒçš„é€€å‡ºæ–¹å¼ï¼š
- `Ctrl+C` (SIGINT)
- `kill` å‘½ä»¤ (SIGTERM)
- æ­£å¸¸é€€å‡º

## é›†æˆåˆ°ä»£ç ä¸­

å¦‚æœéœ€è¦åœ¨ä»£ç ä¸­è®¿é—®ç»Ÿè®¡æ•°æ®ï¼š

```python
from mcp_server.core.tool_stats import get_stats_collector

# è·å–ç»Ÿè®¡æ”¶é›†å™¨
collector = get_stats_collector()

# æ‰‹åŠ¨è®°å½•è°ƒç”¨
collector.record_call(
    tool_name="my_tool",
    task_id="task_123",
    success=True,
    duration_ms=150.5
)

# è·å–ä»»åŠ¡æŠ¥å‘Š
report = collector.get_task_report("task_123")

# è·å–å·¥å…·æŠ¥å‘Š
tool_report = collector.get_tool_report()

# å¯¼å‡ºæŠ¥å‘Š
filepath = collector.export_report("custom_report.json")
```

## æ€§èƒ½è€ƒè™‘

- ç»Ÿè®¡æ”¶é›†å™¨ä½¿ç”¨çº¿ç¨‹é”ä¿è¯çº¿ç¨‹å®‰å…¨
- è®°å½•æ“ä½œéå¸¸è½»é‡ï¼Œå¯¹å·¥å…·è°ƒç”¨æ€§èƒ½å½±å“å¯å¿½ç•¥
- æ‰€æœ‰ç»Ÿè®¡æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ŒæœåŠ¡å™¨é‡å¯åä¼šé‡ç½®
- æŠ¥å‘Šæ–‡ä»¶æŒ‰æ—¶é—´æˆ³å‘½åï¼Œä¸ä¼šè¦†ç›–å†å²æ•°æ®

## æ•…éšœæ’æŸ¥

### ç»Ÿè®¡æ•°æ®ä¸ºç©º

1. ç¡®è®¤å·²å¯ç”¨ç»Ÿè®¡åŠŸèƒ½ï¼š`--enable-stats`
2. æ£€æŸ¥å·¥å…·æ˜¯å¦è¢«æ­£ç¡®åŒ…è£…
3. æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### æ‰¾ä¸åˆ°æŠ¥å‘Šæ–‡ä»¶

1. æ£€æŸ¥ `--stats-dir` å‚æ•°æŒ‡å®šçš„ç›®å½•
2. ç¡®è®¤æœåŠ¡å™¨å·²æ­£å¸¸å…³é—­ï¼ˆç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šï¼‰
3. æ‰‹åŠ¨è°ƒç”¨ `view_tool_stats.py export` å¯¼å‡ºæŠ¥å‘Š

### task_id æ˜¾ç¤ºä¸º "unknown"

1. ç¡®ä¿å·¥å…·å‡½æ•°æ¥æ”¶ `task_id` å‚æ•°
2. æˆ–åœ¨æ³¨å†Œå·¥å…·æ—¶æä¾› `task_id_extractor` å‡½æ•°
3. ä¿®æ”¹å·¥å…·åŒ…è£…å™¨ä»¥æ­£ç¡®æå– task_id

## ç¤ºä¾‹ï¼šå®Œæ•´å·¥ä½œæµç¨‹

```bash
# 1. å¯åŠ¨æœåŠ¡å™¨ï¼ˆå¯ç”¨ç»Ÿè®¡ï¼‰
python src/mcp_server/main.py --config config.json --stats-dir ./my_stats

# 2. è¿è¡Œä»»åŠ¡...ï¼ˆæœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼‰

# 3. æŸ¥çœ‹å®æ—¶æ‘˜è¦
python view_tool_stats.py summary --stats-dir ./my_stats

# 4. å…³é—­æœåŠ¡å™¨ï¼ˆCtrl+Cï¼‰
# è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Šï¼š./my_stats/tool_stats_report_YYYYMMDD_HHMMSS.json

# 5. åˆ†ææŠ¥å‘Š
python view_tool_stats.py failures --stats-dir ./my_stats
python view_tool_stats.py tool --tool-name problematic_tool --stats-dir ./my_stats
```

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®æŒä¹…åŒ–**:
   - é»˜è®¤å¯ç”¨å®æ—¶ä¿å­˜ï¼Œæ¯ 10 æ¬¡è°ƒç”¨å†™å…¥ä¸€æ¬¡ç£ç›˜
   - å³ä½¿æœåŠ¡å™¨å´©æºƒï¼Œå·²è®°å½•çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±
   - å®æ—¶æ—¥å¿—ä½¿ç”¨ JSONL æ ¼å¼ï¼Œæ˜“äºè§£æå’Œåˆ†æ

2. **task_id æå–**:
   - å½“å‰å®ç°ä¼šå°è¯•ä»å‡½æ•°å‚æ•°ä¸­æå– `task_id`
   - å¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ "unknown"

3. **å‚æ•°è®°å½•**:
   - ä»…åœ¨è°ƒç”¨å¤±è´¥æ—¶è®°å½•å®Œæ•´å‚æ•°ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨å’Œå­˜å‚¨ç©ºé—´

4. **çº¿ç¨‹å®‰å…¨**:
   - ç»Ÿè®¡æ”¶é›†å™¨æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨

5. **å†å²æ•°æ®æ¢å¤**:
   - æœåŠ¡å™¨é‡å¯åå¯ä»¥ä»å®æ—¶æ—¥å¿—æ¢å¤æ•°æ®
   - ä½¿ç”¨ `collector.load_from_realtime_log()` æ–¹æ³•

## æ•°æ®æ–‡ä»¶è¯´æ˜

è¿è¡Œåä¼šåœ¨ `tool_stats/` ç›®å½•ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

```
tool_stats/
â”œâ”€â”€ realtime_calls.jsonl                    # å®æ—¶è°ƒç”¨æ—¥å¿—
â”œâ”€â”€ realtime_calls_backup_*.jsonl           # æ—§æ—¥å¿—å¤‡ä»½
â””â”€â”€ tool_stats_report_*.json                # å®Œæ•´ç»Ÿè®¡æŠ¥å‘Š
```

- `realtime_calls.jsonl`: è¿è¡Œæ—¶æŒç»­è¿½åŠ ï¼Œæ¯æ¬¡é‡å¯ä¼šå¤‡ä»½æ—§æ–‡ä»¶
- `tool_stats_report_*.json`: æ¯æ¬¡æ­£å¸¸å…³é—­æ—¶ç”Ÿæˆï¼ŒæŒ‰æ—¶é—´æˆ³å‘½å

## ç›¸å…³æ–‡æ¡£

- [TOOL_STATS_DATA_FORMAT.md](TOOL_STATS_DATA_FORMAT.md) - è¯¦ç»†çš„æ•°æ®æ ¼å¼è¯´æ˜
- [tool_stats_example.json](tool_stats_example.json) - å®Œæ•´æŠ¥å‘Šç¤ºä¾‹
- [realtime_calls_example.jsonl](realtime_calls_example.jsonl) - å®æ—¶æ—¥å¿—ç¤ºä¾‹
