# å•èµ„æºåˆ†é…æµç¨‹è¯¦ç»†è¯´æ˜

## æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯ç¨‹åºå¯åŠ¨                                â”‚
â”‚            (demo_single_resource_flow.py)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1: åˆå§‹åŒ– & è¿æ¥                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  â€¢ åˆ›å»º MCPSSEClient å®ä¾‹                                       â”‚
â”‚  â€¢ è¿æ¥åˆ° MCP Gateway Server (SSE)                             â”‚
â”‚  â€¢ å»ºç«‹æŒä¹…åŒ–è¿æ¥                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2: è·å–å¯ç”¨å·¥å…·åˆ—è¡¨ (å¯é€‰)                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  MCP Request: list_tools()                                     â”‚
â”‚  Response: [                                                   â”‚
â”‚    {name: "allocate_single_resource", ...},                   â”‚
â”‚    {name: "release_batch_resources", ...},                    â”‚
â”‚    {name: "computer", ...},                                   â”‚
â”‚    ...                                                        â”‚
â”‚  ]                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3: åˆ†é…å•ä¸ªèµ„æº                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  MCP Tool Call: allocate_single_resource                       â”‚
â”‚  Parameters:                                                   â”‚
â”‚    â€¢ worker_id: "demo_worker_001"                             â”‚
â”‚    â€¢ resource_type: "vm_pyautogui"                            â”‚
â”‚    â€¢ timeout: 600                                             â”‚
â”‚                                                               â”‚
â”‚  Gateway å†…éƒ¨æµç¨‹:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ 1. æ¥æ”¶å·¥å…·è°ƒç”¨è¯·æ±‚                           â”‚            â”‚
â”‚  â”‚ 2. è°ƒç”¨ allocate_single_resource å‡½æ•°         â”‚            â”‚
â”‚  â”‚ 3. å°è£…ä¸ºå•å…ƒç´ åˆ—è¡¨ ["vm_pyautogui"]          â”‚            â”‚
â”‚  â”‚ 4. HTTP POST â†’ Resource API /allocate        â”‚            â”‚
â”‚  â”‚    Body: {                                   â”‚            â”‚
â”‚  â”‚      "worker_id": "demo_worker_001",         â”‚            â”‚
â”‚  â”‚      "resource_types": ["vm_pyautogui"],     â”‚            â”‚
â”‚  â”‚      "timeout": 600                          â”‚            â”‚
â”‚  â”‚    }                                         â”‚            â”‚
â”‚  â”‚ 5. Resource API åŸå­åˆ†é…èµ„æº                  â”‚            â”‚
â”‚  â”‚ 6. è¿”å›èµ„æºè¿æ¥ä¿¡æ¯                           â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                               â”‚
â”‚  Response:                                                    â”‚
â”‚  {                                                            â”‚
â”‚    "vm_pyautogui": {                                          â”‚
â”‚      "id": "resource_vm_001",                                 â”‚
â”‚      "ip": "192.168.1.100",                                   â”‚
â”‚      "port": 5000,                                            â”‚
â”‚      "token": "auth_token_xyz"                                â”‚
â”‚    }                                                          â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 4: åˆå§‹åŒ–èµ„æºä¼šè¯                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  MCP Tool Call: setup_batch_resources                          â”‚
â”‚  Parameters:                                                   â”‚
â”‚    â€¢ worker_id: "demo_worker_001"                             â”‚
â”‚    â€¢ resource_init_configs: {}                                â”‚
â”‚    â€¢ allocated_resources: {æ­¥éª¤3çš„è¿”å›å€¼}                      â”‚
â”‚                                                               â”‚
â”‚  Gateway å†…éƒ¨æµç¨‹:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ 1. è°ƒç”¨ _sync_resource_sessions()            â”‚            â”‚
â”‚  â”‚    â€¢ æ ¹æ®èµ„æºç±»å‹è¯†åˆ«å¯¹åº”çš„ Server æ¨¡å—       â”‚            â”‚
â”‚  â”‚      vm_pyautogui â†’ vm_pyautogui_server      â”‚            â”‚
â”‚  â”‚    â€¢ åŠ¨æ€å¯¼å…¥æ¨¡å—                            â”‚            â”‚
â”‚  â”‚    â€¢ åˆ›å»º PythonController å®ä¾‹               â”‚            â”‚
â”‚  â”‚      controller = PythonController(          â”‚            â”‚
â”‚  â”‚        vm_ip="192.168.1.100",                â”‚            â”‚
â”‚  â”‚        server_port=5000                      â”‚            â”‚
â”‚  â”‚      )                                       â”‚            â”‚
â”‚  â”‚    â€¢ å†™å…¥æ¨¡å—çš„ GLOBAL_SESSIONS å­—å…¸          â”‚            â”‚
â”‚  â”‚      GLOBAL_SESSIONS["demo_worker_001"] = {  â”‚            â”‚
â”‚  â”‚        "controller": controller,             â”‚            â”‚
â”‚  â”‚        "env_id": "resource_vm_001",          â”‚            â”‚
â”‚  â”‚        "task_id": "batch_allocated"          â”‚            â”‚
â”‚  â”‚      }                                       â”‚            â”‚
â”‚  â”‚                                              â”‚            â”‚
â”‚  â”‚ 2. è°ƒç”¨èµ„æºåˆå§‹åŒ–å‡½æ•°ï¼ˆå¦‚æœæœ‰ init_configï¼‰    â”‚            â”‚
â”‚  â”‚    â€¢ æŸ¥æ‰¾ vm_pyautogui_initialization()      â”‚            â”‚
â”‚  â”‚    â€¢ æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ï¼ˆæœ¬ä¾‹ä¸ºç©ºï¼‰               â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                               â”‚
â”‚  Response:                                                    â”‚
â”‚  {                                                            â”‚
â”‚    "status": "success",                                       â”‚
â”‚    "details": {                                               â”‚
â”‚      "vm_pyautogui": {                                        â”‚
â”‚        "success": true,                                       â”‚
â”‚        "message": "No init logic defined (Success)"           â”‚
â”‚      }                                                        â”‚
â”‚    }                                                          â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 5: è·å–åˆå§‹è§‚å¯Ÿæ•°æ®                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  MCP Tool Call: get_batch_initial_observations                 â”‚
â”‚  Parameters:                                                   â”‚
â”‚    â€¢ worker_id: "demo_worker_001"                             â”‚
â”‚                                                               â”‚
â”‚  Gateway å†…éƒ¨æµç¨‹:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ 1. éå†èµ„æºç±»å‹æ¨¡å—æ˜ å°„è¡¨                     â”‚            â”‚
â”‚  â”‚    vm_module_map = {                         â”‚            â”‚
â”‚  â”‚      "vm_pyautogui": "vm_pyautogui_server",  â”‚            â”‚
â”‚  â”‚      "vm_computer_13": "vm_computer_13_server"â”‚            â”‚
â”‚  â”‚    }                                         â”‚            â”‚
â”‚  â”‚                                              â”‚            â”‚
â”‚  â”‚ 2. åŠ¨æ€å¯¼å…¥å¯¹åº”æ¨¡å—                          â”‚            â”‚
â”‚  â”‚    module = importlib.import_module(         â”‚            â”‚
â”‚  â”‚      "mcp_server.vm_pyautogui_server"        â”‚            â”‚
â”‚  â”‚    )                                         â”‚            â”‚
â”‚  â”‚                                              â”‚            â”‚
â”‚  â”‚ 3. ä» GLOBAL_SESSIONS è·å– Controller        â”‚            â”‚
â”‚  â”‚    session = GLOBAL_SESSIONS["demo_worker_001"]â”‚           â”‚
â”‚  â”‚    controller = session["controller"]        â”‚            â”‚
â”‚  â”‚                                              â”‚            â”‚
â”‚  â”‚ 4. è°ƒç”¨ Controller æ–¹æ³•è·å–è§‚å¯Ÿ               â”‚            â”‚
â”‚  â”‚    screenshot = controller.get_screenshot()  â”‚            â”‚
â”‚  â”‚    a11y_tree = controller.get_accessibility_tree()â”‚       â”‚
â”‚  â”‚                                              â”‚            â”‚
â”‚  â”‚ 5. Base64 ç¼–ç æˆªå›¾                            â”‚            â”‚
â”‚  â”‚    screenshot_b64 = base64.b64encode(screenshot)â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                               â”‚
â”‚  Response:                                                    â”‚
â”‚  {                                                            â”‚
â”‚    "vm_pyautogui": {                                          â”‚
â”‚      "screenshot": "iVBORw0KGgoAAAANS...",                    â”‚
â”‚      "accessibility_tree": "{tree: {...}}",                   â”‚
â”‚      "message": "Observation fetched from local controller"   â”‚
â”‚    }                                                          â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 6: ä½¿ç”¨èµ„æºå·¥å…· (å¯é€‰)                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  ç¤ºä¾‹: MCP Tool Call: computer                                 â”‚
â”‚  Parameters:                                                   â”‚
â”‚    â€¢ worker_id: "demo_worker_001"  (è‡ªåŠ¨æ³¨å…¥)                 â”‚
â”‚    â€¢ action: "screenshot"                                     â”‚
â”‚                                                               â”‚
â”‚  Gateway å†…éƒ¨æµç¨‹:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ 1. ä» GLOBAL_SESSIONS è·å– Controller        â”‚            â”‚
â”‚  â”‚ 2. è°ƒç”¨ controller.screenshot()              â”‚            â”‚
â”‚  â”‚ 3. è¿”å› Base64 ç¼–ç çš„æˆªå›¾                     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                               â”‚
â”‚  Response: {screenshot: "base64_data..."}                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 7: é‡Šæ”¾èµ„æº                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  MCP Tool Call: release_batch_resources                        â”‚
â”‚  Parameters:                                                   â”‚
â”‚    â€¢ worker_id: "demo_worker_001"                             â”‚
â”‚    â€¢ resource_ids: ["resource_vm_001"]                        â”‚
â”‚                                                               â”‚
â”‚  Gateway å†…éƒ¨æµç¨‹:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ 1. éå†èµ„æº ID åˆ—è¡¨                          â”‚            â”‚
â”‚  â”‚ 2. å¯¹æ¯ä¸ªèµ„æºæ‰§è¡Œé‡Šæ”¾                        â”‚            â”‚
â”‚  â”‚    HTTP POST â†’ Resource API /release         â”‚            â”‚
â”‚  â”‚    Body: {                                   â”‚            â”‚
â”‚  â”‚      "worker_id": "demo_worker_001",         â”‚            â”‚
â”‚  â”‚      "resource_id": "resource_vm_001"        â”‚            â”‚
â”‚  â”‚    }                                         â”‚            â”‚
â”‚  â”‚                                              â”‚            â”‚
â”‚  â”‚ 3. è°ƒç”¨ _cleanup_resource_sessions()         â”‚            â”‚
â”‚  â”‚    â€¢ æ¸…ç† vm_pyautogui_server.GLOBAL_SESSIONSâ”‚            â”‚
â”‚  â”‚    â€¢ åˆ é™¤ worker_id å¯¹åº”çš„ä¼šè¯è®°å½•            â”‚            â”‚
â”‚  â”‚      del GLOBAL_SESSIONS["demo_worker_001"]  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                               â”‚
â”‚  Response:                                                    â”‚
â”‚  {                                                            â”‚
â”‚    "status": "completed",                                     â”‚
â”‚    "details": {                                               â”‚
â”‚      "resource_vm_001": "released"                            â”‚
â”‚    }                                                          â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 8: æ–­å¼€è¿æ¥                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  â€¢ å…³é—­ MCP SSE è¿æ¥                                           â”‚
â”‚  â€¢ æ¸…ç†æœ¬åœ°çŠ¶æ€                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æµç¨‹å®Œæˆ    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®æ•°æ®æµ

### 1. èµ„æºåˆ†é…é˜¶æ®µæ•°æ®æµ

```
Client                    Gateway                    Resource API
  â”‚                          â”‚                            â”‚
  â”œâ”€ allocate_single_resource(vm_pyautogui) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ POST /allocate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚   {                        â”‚
  â”‚                          â”‚     resource_types: [      â”‚
  â”‚                          â”‚       "vm_pyautogui"       â”‚
  â”‚                          â”‚     ]                      â”‚
  â”‚                          â”‚   }                        â”‚
  â”‚                          â”‚                            â”‚
  â”‚                          â”‚<â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                          â”‚   {                        â”‚
  â”‚                          â”‚     "vm_pyautogui": {      â”‚
  â”‚                          â”‚       "id": "res_001",     â”‚
  â”‚                          â”‚       "ip": "192.168.1.100",â”‚
  â”‚                          â”‚       "port": 5000         â”‚
  â”‚                          â”‚     }                      â”‚
  â”‚                          â”‚   }                        â”‚
  â”‚<â”€ MCP Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚   (same as above)        â”‚                            â”‚
  â”‚                          â”‚                            â”‚
```

### 2. ä¼šè¯åŒæ­¥é˜¶æ®µæ•°æ®æµ

```
Client                    Gateway                    Server Module
  â”‚                          â”‚                            â”‚
  â”œâ”€ setup_batch_resources(allocated_resources) â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ _sync_resource_sessions() â”‚
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ import vm_pyautogui_serverâ”‚
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ create PythonController  â”‚
  â”‚                          â”‚   (ip, port)               â”‚
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ write to GLOBAL_SESSIONS â”€>â”‚
  â”‚                          â”‚   {                        â”‚
  â”‚                          â”‚     "worker_id": {         â”‚
  â”‚                          â”‚       "controller": obj,   â”‚
  â”‚                          â”‚       "env_id": "res_001"  â”‚
  â”‚                          â”‚     }                      â”‚
  â”‚                          â”‚   }                        â”‚
  â”‚<â”€ MCP Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚   {status: "success"}    â”‚                            â”‚
  â”‚                          â”‚                            â”‚
```

### 3. è§‚å¯Ÿè·å–é˜¶æ®µæ•°æ®æµ

```
Client                    Gateway                    Controller
  â”‚                          â”‚                            â”‚
  â”œâ”€ get_batch_initial_observations() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ get session from         â”‚
  â”‚                          â”‚   GLOBAL_SESSIONS          â”‚
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ controller.get_screenshot() â”€>â”‚
  â”‚                          â”‚<â”€ PNG bytes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ controller.get_accessibility_tree() >â”‚
  â”‚                          â”‚<â”€ tree JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ base64 encode screenshot  â”‚
  â”‚                          â”‚                            â”‚
  â”‚<â”€ MCP Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚   {                      â”‚                            â”‚
  â”‚     "vm_pyautogui": {    â”‚                            â”‚
  â”‚       "screenshot": "b64",â”‚                           â”‚
  â”‚       "a11y_tree": "{}"  â”‚                            â”‚
  â”‚     }                    â”‚                            â”‚
  â”‚   }                      â”‚                            â”‚
  â”‚                          â”‚                            â”‚
```

### 4. èµ„æºé‡Šæ”¾é˜¶æ®µæ•°æ®æµ

```
Client                    Gateway                    Resource API
  â”‚                          â”‚                            â”‚
  â”œâ”€ release_batch_resources([res_001]) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ POST /release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚   {                        â”‚
  â”‚                          â”‚     resource_id: "res_001" â”‚
  â”‚                          â”‚   }                        â”‚
  â”‚                          â”‚<â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                          â”‚                            â”‚
  â”‚                          â”œâ”€ _cleanup_resource_sessions()â”‚
  â”‚                          â”‚   del GLOBAL_SESSIONS[worker_id]â”‚
  â”‚                          â”‚                            â”‚
  â”‚<â”€ MCP Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚   {                      â”‚                            â”‚
  â”‚     status: "completed", â”‚                            â”‚
  â”‚     details: {...}       â”‚                            â”‚
  â”‚   }                      â”‚                            â”‚
  â”‚                          â”‚                            â”‚
```

## ä¸æ‰¹é‡èµ„æºåˆ†é…çš„å¯¹æ¯”

### æ‰¹é‡èµ„æºåˆ†é… (allocate_batch_resources)

```python
# ä¸€æ¬¡æ€§åˆ†é…å¤šä¸ªèµ„æº
result = await call_tool("allocate_batch_resources", {
    "worker_id": "worker_001",
    "resource_types": ["vm_pyautogui", "rag", "vm_computer_13"],
    "timeout": 600
})

# è¿”å›æ ¼å¼
{
    "vm_pyautogui": {"id": "...", "ip": "...", ...},
    "rag": {"id": "...", "base_url": "...", ...},
    "vm_computer_13": {"id": "...", "ip": "...", ...}
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… åŸå­æ€§ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- âœ… é˜²æ­»é”ï¼šåç«¯ä¿è¯èµ„æºåˆ†é…é¡ºåºä¸€è‡´
- âš ï¸ å¤æ‚åº¦ï¼šéœ€è¦åè°ƒå¤šç§èµ„æºç±»å‹
- ğŸ“ ç”¨ä¾‹ï¼šéœ€è¦å¤šèµ„æºååŒçš„å¤æ‚ä»»åŠ¡

### å•èµ„æºåˆ†é… (allocate_single_resource)

```python
# åªåˆ†é…ä¸€ä¸ªèµ„æº
result = await call_tool("allocate_single_resource", {
    "worker_id": "worker_001",
    "resource_type": "vm_pyautogui",
    "timeout": 600
})

# è¿”å›æ ¼å¼ï¼ˆç›¸åŒï¼‰
{
    "vm_pyautogui": {"id": "...", "ip": "...", ...}
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç®€å•ï¼šåªéœ€æŒ‡å®šå•ä¸ªèµ„æºç±»å‹
- âœ… çµæ´»ï¼šå¯ä»¥æŒ‰éœ€åˆ†é…ä¸åŒèµ„æº
- âš ï¸ æ‰‹åŠ¨ç®¡ç†ï¼šéœ€è¦è‡ªå·±å¤„ç†å¤šèµ„æºæƒ…å†µ
- ğŸ“ ç”¨ä¾‹ï¼šå•ä¸€èµ„æºçš„ç®€å•ä»»åŠ¡

## ä»£ç æ˜ å°„

### allocate_single_resource å®ç°
[src/mcp_server/system_tools.py:47-85](src/mcp_server/system_tools.py#L47-L85)

```python
@ToolRegistry.register_tool("system_resource", hidden=True)
async def allocate_single_resource(worker_id: str, resource_type: str, timeout: int = 600) -> str:
    # å°è£…ä¸ºå•å…ƒç´ åˆ—è¡¨
    resource_types = [resource_type]

    # å¤ç”¨æ‰¹é‡åˆ†é…æ¥å£
    async with httpx.AsyncClient() as client:
        resp = await client.post(
            f"{RESOURCE_API_URL}/allocate",
            json={
                "worker_id": worker_id,
                "resource_types": resource_types,
                "timeout": timeout
            }
        )
        return json.dumps(resp.json())
```

### _sync_resource_sessions å®ç°
[src/mcp_server/system_tools.py:263-333](src/mcp_server/system_tools.py#L263-L333)

```python
async def _sync_resource_sessions(worker_id: str, allocated_resources: dict):
    # VM èµ„æºåŒæ­¥
    vm_module_map = {
        "vm_pyautogui": "mcp_server.vm_pyautogui_server",
        "vm_computer_13": "mcp_server.vm_computer_13_server"
    }

    for res_type, res_info in allocated_resources.items():
        if res_type in vm_module_map:
            module = importlib.import_module(vm_module_map[res_type])
            controller = PythonController(
                vm_ip=res_info["ip"],
                server_port=res_info["port"]
            )
            module.GLOBAL_SESSIONS[worker_id] = {
                "controller": controller,
                "env_id": res_info["id"]
            }
```

### _cleanup_resource_sessions å®ç°
[src/mcp_server/system_tools.py:335-363](src/mcp_server/system_tools.py#L335-L363)

```python
async def _cleanup_resource_sessions(worker_id: str):
    # æ¸…ç† VM æ¨¡å—ä¼šè¯
    vm_modules = [
        "mcp_server.vm_pyautogui_server",
        "mcp_server.vm_computer_13_server"
    ]

    for module_name in vm_modules:
        module = importlib.import_module(module_name)
        if hasattr(module, "GLOBAL_SESSIONS"):
            target_sessions = getattr(module, "GLOBAL_SESSIONS")
            if worker_id in target_sessions:
                del target_sessions[worker_id]
```

## æ€»ç»“

å•èµ„æºåˆ†é…æµç¨‹å®ç°äº†ï¼š

1. âœ… **ç®€åŒ–æ¥å£**ï¼šåªéœ€æŒ‡å®šä¸€ä¸ªèµ„æºç±»å‹
2. âœ… **å¤ç”¨æœºåˆ¶**ï¼šå†…éƒ¨ä½¿ç”¨æ‰¹é‡åˆ†é…æ¥å£
3. âœ… **è‡ªåŠ¨åŒæ­¥**ï¼šè‡ªåŠ¨åŒæ­¥ä¼šè¯åˆ°å¯¹åº”æ¨¡å—
4. âœ… **ç»Ÿä¸€é‡Šæ”¾**ï¼šä½¿ç”¨æ‰¹é‡é‡Šæ”¾æ¥å£
5. âœ… **å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**ï¼šåˆ†é… â†’ åˆå§‹åŒ– â†’ ä½¿ç”¨ â†’ é‡Šæ”¾

é€‚ç”¨åœºæ™¯ï¼š
- ç®€å•ä»»åŠ¡åªéœ€å•ä¸€èµ„æº
- æŒ‰éœ€åŠ¨æ€åˆ†é…ä¸åŒèµ„æº
- å­¦ä¹ å’Œç†è§£èµ„æºç®¡ç†æœºåˆ¶
